<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Auditoría de Recursos | FISI Libros</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-light">
    <div th:replace="~{includes/menu :: menu}"></div>

    <main class="container mt-4 mb-5">
        <div class="d-flex justify-content-between align-items-end mb-4">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb small mb-1">
                        <li class="breadcrumb-item"><a th:href="@{/}">Inicio</a></li>
                        <li class="breadcrumb-item active">Panel de Autor</li>
                    </ol>
                </nav>
                <h2 class="fw-bold mb-0 text-dark">Auditoría de Recursos Digitales</h2>
            </div>
            <button class="btn btn-dark shadow-sm" onclick="window.print()">
                <i class="bi bi-printer me-2"></i>Exportar Informe PDF
            </button>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="p-3 bg-white shadow-sm rounded-3 border-start border-4 border-primary">
                    <small class="text-muted text-uppercase fw-bold">Vistas Acumuladas</small>
                    <h4 class="mb-0 fw-bold" th:text="${totalVistas != null ? totalVistas + ' lecturas' : '0 lecturas'}">0 lecturas</h4>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 bg-white shadow-sm rounded-3 border-start border-4 border-dark">
                    <small class="text-muted text-uppercase fw-bold">Total de Obras</small>
                    <h4 class="mb-0 fw-bold" th:text="${totalLibros + ' ejemplares'}">0 ejemplares</h4>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 bg-white shadow-sm rounded-3 border-start border-4 border-info">
                    <small class="text-muted text-uppercase fw-bold">Ocupación Azure</small>
                    <h4 class="mb-0 fw-bold" th:text="${#numbers.formatDecimal(espacioTotal, 1, 2) + ' MB'}">0,00 MB</h4>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm mb-4" style="border-radius: 15px;">
            <div class="card-body p-4">
                <h5 class="fw-bold mb-4"><i class="bi bi-bar-chart-line me-2"></i>Rendimiento de Publicaciones</h5>
                <div style="height: 320px;">
                    <canvas id="graficaVistas"></canvas>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm" style="border-radius: 15px;">
            <div class="table-responsive p-4">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Obra / Título</th>
                            <th class="text-center">Vistas</th>
                            <th class="text-center">Estado</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="libro : ${libros}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <img th:src="${libro.portadaUrl}" class="rounded me-3 shadow-sm" 
                                         style="width: 40px; height: 55px; object-fit: cover;" alt="Portada">
                                    <div>
                                        <div class="fw-bold text-dark" th:text="${libro.titulo}">Título del Libro</div>
                                        <small class="text-muted" th:text="${libro.autorUsuario.nombre}">Nombre del Autor</small>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-light text-dark border px-3" th:text="${libro.vistas}">0</span>
                            </td>
                            <td class="text-center">
                                <span th:if="${libro.estado}" class="badge bg-success-subtle text-success border border-success px-3">Activo</span>
                                <span th:unless="${libro.estado}" class="badge bg-danger-subtle text-danger border border-danger px-3">Inactivo</span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group shadow-sm" role="group">
                                    <a th:href="@{/libros/editar/{id}(id=${libro.id})}" 
                                       class="btn btn-outline-primary btn-sm px-3">
                                        <i class="bi bi-pencil-square me-1"></i> Editar
                                    </a>
                                    
                                    <button type="button" class="btn btn-outline-danger btn-sm px-3" 
                                            th:onclick="'confirmarEliminacion(' + ${libro.id} + ')'">
                                        <i class="bi bi-trash3 me-1"></i> Retirar
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <footer th:replace="~{includes/footer :: footer}"></footer>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // Pasamos la lista de libros al objeto global que usará script.js para la gráfica
        const dataLibrosReporte = /*[[${libros}]]*/ [];
        /*]]>*/
    </script>
    
    <script th:src="@{/js/script.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>